# 競技マニュアル

## 競技の開始

VM 環境での競技開始手順の説明をします。

1. 配布された秘密鍵のアクセス権限を適切に設定してください。

```
$ chmod 400 {秘密鍵のパス}
```

配布された環境 ID および秘密鍵を使って、環境にログインしてください。

```
$ ssh -i {秘密鍵ファイルのパス} azureuser@{環境ID}.ftt2306.dabaas.net
```

リポジトリのルートディレクトリにある`init.sh`を実行してください。
docker コンテナが起動し、初期データが投入されます。

```
$ bash init.sh
```

## 投入されているユーザーデータ

- mysql の user テーブルに、ユーザーのデータが登録されています。
- ユーザーは 約 30 万人登録されています。
- 各ユーザーは、メールアドレス: `popy${数字}@example.com`、パスワード: `pass${数字}`でログイン可能です。
- テスト用のセッションが mysql の session テーブルに登録されており、`session_id`が`test-session-id`、`linked_user_id`が`test-user-id`となっています。
- このレコードを削除すると、負荷試験がログイン API 以外失敗するため、誤って消してしまった場合はリストアを試すか、session テーブルに再度レコードを登録してください。

## 最終スコアの提出

VM 環境で採点が成功したものは、運営に結果が送信されます。採点は何度も実施可能です。

## スクリプトの紹介

競技に必要、または利用できそうなスクリプトを用意しています。それぞれの概要を説明します。

注意:

- すべて、スクリプト配置フォルダ内で直接実行してください。
- ファイルを削除するスクリプトが含まれます。実行環境にお気をつけください。

### ビルド

場所: `app/`

`app/`の現在の内容でイメージおよびコンテナを作成し、サービスを立ち上げます。

```
$ bash restart_container.sh
```

### 負荷試験 & 採点

場所: `benchmarker/`

現在起動しているサービスに対し、採点を行います。実行には数分かかります。

最新の内容で採点したい場合は、別途上記のビルドスクリプトを実行してください。

```
$ bash run_k6_and_score.sh
```

### API テスト

場所: `benchmarker/`

採点時に実施される API テストを制約付きで実行できます。

制約及び注意:

- データのリストアを省略するため、評価スクリプトより早く実行できます。
- 評価スクリプトとは異なり、[http://localhost/]()宛にテストを実施します。
- このスクリプトの結果は OK だが採点スクリプトではテスト結果が NG の場合、後者が優先されます。

```
$ bash e2e.sh
```

### リストア

場所: `benchmarker/`

採点時に実施されるデータリストアのみを行います。簡易 DB マイグレーションも実施されます。

実行には数分かかります。

```
$ bash restore_and_migration.sh
```

## 簡易 DB マイグレーション機能

評価スクリプトを実行する度にデータベースの状態は戻ってしまいますが、あらかじめ登録された SQL を実行させ、テーブル等への変更を採点前に反映させることができます。

`app/`ディレクトリの`mysql/mysql_migration/`に置かれた{数字}\_\*.sql ファイルは、採点前に実行されます。
0_name.sql, 1_name.sql...という名称のファイルを置いておくことで、番号が若い順に実行されていきます。

## 評価スクリプト

場所: `ルートディレクトリ`

上記の各ステップを順次実行するスクリプトを用意しています。

VM 上の採点も、このスクリプトを実行して行います。

```
$ bash run.sh
```

## 競技中及び競技環境に関する注意

- 競技環境の HDD の容量はそこまで潤沢ではありません。不要なリソースは削除するようにしてください。
- リポジトリのディレクトリ構成を変えないようにしてください。スクリプトが動作しなくなる場合があります。
- `/.da`領域は変更しないでください。動作しなくなる場合があります。また、中身の持ち出しも禁止です。
- OS をシャットダウンした場合、参加者は SSH ログインできなくなります。ドリーム・アーツ社員でないと復旧できないため時間をロスすることになります。
- Azure 障害により競技環境が一時的に使用できなくなった場合でも、課題提出締め切りの延長はありません。
- OS を書き換える等により競技環境が破損し環境再構築が発生した場合も、課題提出締め切りの延長はありません。

## 環境の制約事項

競技主催者側の都合上、やむを得ず現実的なシナリオと乖離している箇所があります。これを利用しても業務アプリケーションの改善とは言い難いため、あらかじめ共有します。

- 初期データに含まれる添付ファイルは同じ内容を使い回している
  - HDD 容量制限のため。
  - 同じファイルが参照されることがありますが、基本的には別の添付ファイルとして扱ってください
- API テストは、一部のテスト用のユーザ情報を利用して実施される
  - ユーザの識別はアクセス状況から容易にわかりますが、この情報を使って API テストだけ PASS する最適化は、レギュレーション違反です

## FAQ

- Q. 何もしていないのに、スコアが下がる
  - スコアは負荷試験による実測値をベースにする性質上、同一条件でも採点結果が多少上下します。
  - ある改善前後でスコアが下がっても、効果が全くなかったと断定できない場合があるので注意してください
- Q. データの整合性はどこまで気をつければいいですか。アプリが実行中にクラッシュしたシナリオの対応など。
  - まずは最低限 API テストが通るレベルにしておいてください。
  - 例えば負荷試験中の更新内容を全てメモリのみに保管し永続化しない場合、電源断で負荷試験中のデータは全て消失するため、これは業務アプリ向けの改善とは言い難いです。
- Q. 画像の圧縮や変換はどこまで認められますか？
  - API 仕様書に則っており、API テストが通っていれば ok。
- Q. データベースのテーブルの構造を変更しても良いですか？
  - 不可です。
- Q. ライブラリやツールを VM にインストールしても構いませんか？
  - OK です。
- Q. 追加で VM のファイアウォールのポートを開放できますか？
  - できません。HTTPS,SSH のみの開放です。
- Q. nginx や mysql を別のものに変更したり、backend を別の言語で実装しても良いですか？
  - OK です。
- Q. 評価スクリプトの実行を繰り返すと、スコアがどんどん下がっていく
  - 初期の実装では、DockerEngine に負荷がかかっている可能性があります。DockerEngine の再起動が有効な可能性があります。
- Q. どこまでが改善対象ですか？
  - 採点時の負荷試験は HTTPS 接続で各 API へリクエストを送ります。nginx や mysql、backend コンテナといった API の機能を成立させるためのモジュールは改善対象です
  - 要件を満たしていれば、これらのモジュールを全く差し替えてしまうことも可能です。
  - frontend コンテナ及びそれを実行するクライアントについては負荷試験のリクエスト対象に入っていないため改善しても効果はあまり見込めません
- Q. リストアされたデータの中身を見ること / 分析することは可能ですか？
  - 可能です。お客様からは許可は取っているものとします。
- Q. API テスト時にたくさん失敗する
  - API テストではそれぞれのテストの結果を利用して後続のテストを行なっている箇所があります
  - 前提となる項目が PASS しない場合、後続のテスト項目も(仕様に適合しているかにかかわらず)失敗する場合があります
  - あまり大幅に実装を変更してまとめて API テストを実施すると問題点がわかりにくくなるため、こまめに API テストを実施することをお勧めします。
- Q. 用意されたスクリプトは使わなくてもいいですか？
  - 採点は評価スクリプトの実行結果のみ認められますが、それ以外のスクリプトは好みに合わせて使い分けてください
- Q. 意図せずレギュレーション違反をしてしまった
  - 考慮する場合があります

## その他

### インフラ情報

競技環境は Azure で構築しています。

- VM: Standard D2as v4 (2 vcpu 数、8 GiB メモリ)
- ディスク: StandardHDD S4

### ローカル環境での開発

[こちらを参照](./98_local.md)

```

```
